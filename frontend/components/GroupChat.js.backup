import { useState, useEffect, useRef } from 'react';

export default function GroupChat({ groupId, user, isOpen, onClose, connected, messages, sendMessage }) {
  const [messageInput, setMessageInput] = useState('');
  const [groupMessages, setGroupMessages] = useState([]);
  const chatWindowRef = useRef(null);
  
  // Try different possible field names for user ID
  const userId = user?.id || user?.userID || user?.user_id;

  // Load existing messages when group chat opens
  const loadExistingMessages = async () => {
    setLoadingMessages(true);
    try {
      console.log('ğŸ“¥ Loading existing messages for group:', groupId);
      const response = await fetch(`/api/group-messages?group_id=${groupId}`, {
        credentials: 'include'
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log('ï¿½ Raw response:', data);
        const messages = data.messages || data || [];
        console.log('ğŸ“š Loaded existing messages:', messages);
        setExistingMessages(messages);
      } else {
        console.error('Failed to load messages:', response.status);
        setExistingMessages([]);
      }
    } catch (error) {
      console.error('Error loading messages:', error);
      setExistingMessages([]);
    } finally {
      setLoadingMessages(false);
    }
  };  // Load messages when chat opens
  useEffect(() => {
    if (isOpen && groupId) {
      loadExistingMessages();
    }
  }, [isOpen, groupId]);

    // Combine existing messages and real-time messages
  useEffect(() => {
    console.log('ğŸ”„ Combining messages - Existing:', existingMessages.length, 'Real-time:', messages.length);
    
    // Filter real-time messages for this group
    const realtimeGroupMessages = messages.filter(msg => 
      msg.type === 'group_message' && msg.group_id === parseInt(groupId)
    );
    
    // Combine and sort all messages
    const allMessages = [...existingMessages, ...realtimeGroupMessages];
    
    // Remove duplicates and sort by timestamp
    const uniqueMessages = allMessages.filter((msg, index, arr) => {
      return index === arr.findIndex(m => 
        m.content === msg.content && 
        m.from === msg.from && 
        Math.abs(new Date(m.timestamp || m.created_at) - new Date(msg.timestamp || msg.created_at)) < 1000
      );
    }).sort((a, b) => 
      new Date(a.timestamp || a.created_at) - new Date(b.timestamp || b.created_at)
    );
    
    console.log('âœ… Final combined messages:', uniqueMessages);
    setGroupMessages(uniqueMessages);
  }, [existingMessages, messages, groupId]);

  // Auto scroll to bottom when new messages arrive
  useEffect(() => {
    if (chatWindowRef.current) {
      chatWindowRef.current.scrollTop = chatWindowRef.current.scrollHeight;
    }
  }, [groupMessages]);

  const handleSendMessage = (e) => {
    e.preventDefault();
    
    if (!messageInput.trim() || !connected) return;
    
    const messageData = {
      type: 'group_message',
      group_id: parseInt(groupId),
      from: userId, // Use the consistent userId we defined above
      username: user?.username || `User ${userId}`, // Add username for display
      content: messageInput.trim(),
      timestamp: new Date().toISOString()
    };
    
    console.log('ğŸ“¤ Sending group message:', messageData);
    if (sendMessage(messageData)) {
      console.log('âœ… Message sent successfully');
      setMessageInput('');
    } else {
      console.error('âŒ Failed to send message');
    }
  };

  if (!isOpen) return null;

  return (
    <div className="modal">
      <div className="modal-content" style={{maxWidth: '400px', maxHeight: '80vh', display: 'flex', flexDirection: 'column'}}>
        {/* Header */}
        <div className="chat-header" style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '16px',
          borderBottom: '1px solid #e4e6ea',
          paddingBottom: '12px'
        }}>
          <h3 style={{fontSize: '18px', fontWeight: '500', color: '#1c1e21'}}>Group Chat</h3>
          <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
            <span 
              style={{
                display: 'inline-block',
                width: '8px',
                height: '8px',
                borderRadius: '50%',
                backgroundColor: connected ? '#42b883' : '#e0245e'
              }}
            ></span>
            <span style={{fontSize: '12px', color: '#65676b'}}>{connected ? 'Connected' : 'Disconnected'}</span>
            <button 
              onClick={onClose}
              className="close"
            >
              Ã—
            </button>
          </div>
        </div>

        {/* Messages */}
        <div 
          ref={chatWindowRef}
          className="group-chat-window"
        >
          {groupMessages.length === 0 ? (
            <div style={{textAlign: 'center', color: '#65676b', padding: '32px'}}>
              <p>No messages yet. Start the conversation!</p>
            </div>
          ) : (
            groupMessages.map((msg, index) => (
              <div
                key={index}
                className={`group-chat-message ${msg.from === userId ? 'my-message' : 'other-message'}`}
              >
                <div className="bubble">
                  {msg.from !== userId && (
                    <div className="meta">
                      <span style={{fontWeight: '500'}}>{msg.username || `User ${msg.from}`}</span>
                    </div>
                  )}
                  <div className="text">{msg.content}</div>
                  <div className="meta" style={{justifyContent: msg.from === userId ? 'flex-end' : 'flex-start'}}>
                    <span>{new Date(msg.timestamp).toLocaleTimeString()}</span>
                  </div>
                </div>
              </div>
            ))
          )}
        </div>

        {/* Message Input */}
        <form onSubmit={handleSendMessage} style={{display: 'flex', gap: '8px'}}>
          <input
            type="text"
            value={messageInput}
            onChange={(e) => setMessageInput(e.target.value)}
            placeholder={connected ? "Type your message..." : "Connecting..."}
            disabled={!connected}
            style={{
              flex: 1,
              padding: '8px 12px',
              border: '1px solid #dddfe2',
              borderRadius: '6px',
              fontSize: '14px',
              backgroundColor: !connected ? '#f0f0f0' : 'white'
            }}
          />
          <button
            type="submit"
            disabled={!connected || !messageInput.trim()}
            className="btn btn-primary"
            style={{
              backgroundColor: (!connected || !messageInput.trim()) ? '#bec3c9' : '#4267B2'
            }}
          >
            Send
          </button>
        </form>
      </div>
    </div>
  );
}